<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Security Bathroom Tracker</title>
    <link rel="stylesheet" href="css/main.css" />
  </head>
  <body>
    <header>Security Bathroom Tracker</header>

    <form
      class="panel"
      id="bathroom-tracker"
      action="https://script.google.com/macros/s/AKfycbyfgyRcACCIHC_qGMT_5vc8m0iwT40pA2Ik25i5DAuQ5BAZKsyM6u_klJ_PU1xO2HoG/exec"
      method="POST"
    >
      <!-- Name Field -->
      <section class="name-input">
        <label id="id-name-input" for="staffName">Your Name:</label>
        <input
          type="text"
          id="staffName"
          name="Name"
          placeholder="Enter your name"
          required
        />
      </section>

      <section class="gender-input">
        <label>Bathroom Type:</label><br />
        <label>
          <input type="radio" name="Gender" value="Girls" required />
          Girls
        </label>
        <label>
          <input type="radio" name="Gender" value="Boys" required />
          Boys
        </label>
      </section>

      <!-- Location Buttons (each one submits the form) -->
      <main>
        <button type="submit" name="Location" value="1st Floor Maint T BR">
          1st Floor Maint T BR
        </button>
        <button type="submit" name="Location" value="1st Floor Elv T BR">
          1st Floor Elv T BR
        </button>
        <button type="submit" name="Location" value="300 POD BR">
          300 POD BR
        </button>
        <button type="submit" name="Location" value="500 POD BR">
          500 POD BR
        </button>
        <button type="submit" name="Location" value="2nd Floor Maint T BR">
          2nd Floor Maint T BR
        </button>
        <button type="submit" name="Location" value="2nd Floor Elv T BR">
          2nd Floor Elv T BR
        </button>
        <button type="submit" name="Location" value="400 POD  BR">
          400 POD BR
        </button>
        <button type="submit" name="Location" value="600 POD BR">
          600 POD BR
        </button>
      </main>
    </form>

    <script>
      (function () {
        const form = document.getElementById("bathroom-tracker");
        const nameInput = document.getElementById("staffName");

        // Use the form's action as the endpoint (no hardcoded placeholder)
        const WEB_APP_URL = form.action;

        // Remember last clicked location for browsers without e.submitter
        let lastLocation = "";
        form.querySelectorAll('button[name="Location"]').forEach((btn) => {
          btn.addEventListener("click", () => {
            lastLocation = btn.value;
          });
        });

        // Prefill saved values
        nameInput.value = localStorage.getItem("user-name") || "";
        const savedGender = localStorage.getItem("user-gender");
        if (savedGender) {
          const g = document.querySelector(
            `input[name="Gender"][value="${savedGender}"]`
          );
          if (g) g.checked = true;
        }

        // Simple toast
        const toast = document.createElement("div");
        Object.assign(toast.style, {
          position: "fixed",
          left: "50%",
          bottom: "16px",
          transform: "translateX(-50%)",
          padding: "8px 12px",
          borderRadius: "10px",
          fontSize: "0.9rem",
          background: "rgba(0,0,0,0.7)",
          color: "#fff",
          opacity: "0",
          transition: "opacity 180ms ease",
          pointerEvents: "none",
        });
        document.body.appendChild(toast);
        function showToast(msg) {
          toast.textContent = msg;
          toast.style.opacity = "1";
          setTimeout(() => (toast.style.opacity = "0"), 1200);
        }

        // Intercept submit (background POST)
        form.addEventListener("submit", function (e) {
          e.preventDefault();

          // Prefer e.submitter, fall back to lastLocation
          const submitter = e.submitter;
          const locationValue =
            (submitter && submitter.name === "Location" && submitter.value) ||
            lastLocation ||
            "";

          const nameValue = (nameInput.value || "").trim();
          const genderRadio = document.querySelector(
            'input[name="Gender"]:checked'
          );
          const genderValue = genderRadio ? genderRadio.value : "";

          if (!nameValue) {
            nameInput.focus();
            showToast("Enter name");
            return;
          }
          if (!genderValue) {
            showToast("Select Girls or Boys");
            return;
          }
          if (!locationValue) {
            showToast("Pick a location");
            return;
          }

          // Build URL-encoded body
          const params = new URLSearchParams();
          params.append("Name", nameValue);
          params.append("Location", locationValue);
          params.append("Gender", genderValue);

          fetch(WEB_APP_URL, {
            method: "POST",
            mode: "no-cors",
            headers: { "Content-Type": "application/x-www-form-urlencoded" },
            body: params.toString(),
          }).catch(() => {});

          // Persist name/gender; reset only transient fields
          localStorage.setItem("user-name", nameValue);
          localStorage.setItem("user-gender", genderValue);

          form.reset();
          nameInput.value = nameValue;
          const restore = document.querySelector(
            `input[name="Gender"][value="${genderValue}"]`
          );
          if (restore) restore.checked = true;
          nameInput.focus();
          lastLocation = ""; // clear
          showToast("Recorded");
        });
      })();
    </script>
  </body>
</html>
